# -*- python -*-
# ex: set syntax=python:

from buildbot.buildslave import BuildSlave
from buildbot.process import factory
from buildbot.status import html
from buildbot.steps import source, shell

import local_config as config



################################################################################
#
# General settings
#
################################################################################



c = BuildmasterConfig = {}

c['projectName'] = 'MWorks'
c['projectURL'] = config.project_url
c['buildbotURL'] = 'http://%s:%d/' % (config.buildbot_hostname,
                                      config.webstatus_port)

c['status'] = [html.WebStatus(http_port=config.webstatus_port, allowForce=True)]

default_xcode_configuration = 'Development (10.5 Compatible)'



################################################################################
#
# Build slaves
#
################################################################################



macosx_10_5_x86_64 = 'MacOSX-10.5-x86_64'
macosx_10_6_x86_64 = 'MacOSX-10.6-x86_64'

slave_names = [macosx_10_5_x86_64, macosx_10_6_x86_64]
default_slavename = macosx_10_6_x86_64

c['slaves'] = [BuildSlave(name, config.slave_pass) for name in slave_names]
c['slavePortnum'] = config.slave_port



################################################################################
#
# Builders
#
################################################################################



def git_step(reponame, mode='update'):
    repourl = '%s/%s.git' % (config.repository_base_url, reponame)
    return source.Git(repourl=repourl, mode=mode)


def shell_step(*args, **kwargs):
    return shell.ShellCommand(*args, **kwargs)


def xcodebuild_step(target, configuration=default_xcode_configuration):
    return shell_step(
        command = [
            'xcodebuild',
            '-target', target,
            '-configuration', configuration,
            'clean',
            'build',
            ],
        description = 'building',
        descriptionDone = 'build',
        )


build_steps = {

    'build_mw_supporting': [
        git_step('mw_supporting'),
        shell_step(
            command = ['git', 'submodule', 'update', '--init'],
            ),
        shell_step(
            command = ['python', 'fresh_build.py'],
            ),
        ],

    'build_mw_scarab': [
        git_step('mw_scarab'),
        xcodebuild_step('libscarab.a'),
        ],

    }


c['builders'] = []

for builder_name, factory_steps in build_steps.iteritems():
    c['builders'].append(BuilderConfig(
            name = builder_name,
            slavename = default_slavename,
            factory = factory.BuildFactory(factory_steps),
            ))
